<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
    <title>Final Test Receiver</title>
    <style>
       html, body {
            background-color: #000;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }
        #debug {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            word-wrap: break-word;
        }
        #iframewrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
        }
        iframe {
            width: 2394px; /* Target width */
            height: 1241px; /* Target height */
            transform-origin: 0 0;
            border: none;
        }
    </style>
</head>
<body>
    <div id="debug">Starting...</div>






    <script>
class IframeScaler {
    constructor(config = {}) {
        this.config = {
            scale: config.scale || 1,
            aspect: config.aspect || 'native',
            rotation: config.rotation || 0,
            overscan: config.overscan || [0, 0, 0, 0], // [top, right, bottom, left]
            transition: config.transition || 'fade'
        };
        
        this.container = null;
        this.iframe = null;
        this.initialize();
    }

    initialize() {
        // Create container and iframe
        this.container = document.createElement('div');
        this.container.className = 'frame-container';
        
        this.iframe = document.createElement('iframe');
        this.iframe.className = 'scaled-frame';
        
        this.container.appendChild(this.iframe);
        document.body.appendChild(this.container);

        // Add base styles
        const style = document.createElement('style');
        style.textContent = `
            .frame-container {
                position: absolute;
                top: 50%;
                left: 50%;
                transform-origin: center center;
                transition: transform 0.3s ease;
            }
            .scaled-frame {
                border: none;
                width: 100%;
                height: 100%;
            }
        `;
        document.head.appendChild(style);

        // Handle window resize
        window.addEventListener('resize', () => this.updateScaling());
        
        // Initial scaling
        this.updateScaling();
    }

    getViewportDimensions() {
        const overscan = this.config.overscan;
        return {
            width: document.body.clientWidth - overscan[1] - overscan[3],
            height: document.body.clientHeight - overscan[0] - overscan[2]
        };
    }

    calculateAspectRatio() {
        const viewport = this.getViewportDimensions();
        return typeof this.config.aspect === 'number' 
            ? this.config.aspect 
            : viewport.width / viewport.height;
    }

    updateScaling() {
        const viewport = this.getViewportDimensions();
        const targetAspect = this.calculateAspectRatio();
        const scale = this.config.scale;
        
        // Calculate scaling factors
        const scaleX = (viewport.width / viewport.height * scale) / targetAspect;
        const scaleY = scale;

        // Calculate dimensions
        const isRotated = this.config.rotation % 180 === 90;
        const width = isRotated ? viewport.height / scaleY : viewport.width / scaleX;
        const height = isRotated ? viewport.width / scaleX : viewport.height / scaleY;

        // Apply styles
        this.container.style.width = `${width}px`;
        this.container.style.height = `${height}px`;
        this.container.style.marginLeft = `${-width / 2}px`;
        this.container.style.marginTop = `${-height / 2}px`;

        // Build transform string
        const transforms = [
            `scale(${scaleX}, ${scaleY})`,
            `rotate(${this.config.rotation}deg)`
        ];
        this.container.style.transform = transforms.join(' ');
    }

    setUrl(url) {
        this.iframe.src = url;
    }

    updateConfig(newConfig) {
        this.config = { ...this.config, ...newConfig };
        this.updateScaling();
    }
}


const scaler = new IframeScaler({
    scale: 1,
    aspect:16/9,  // Your target aspect ratio
    rotation: 0,
    overscan: [0, 0, 0, 0]
});



        const NAMESPACE = 'urn:x-cast:com.screeninfo.app';
        const debug = document.getElementById('debug');
        const startTime = Date.now();

        function log(message) {
            const time = ((Date.now() - startTime) / 1000).toFixed(1);
            const logMessage = `[${time}s] ${message}`;
            console.log(logMessage);
            debug.innerHTML = logMessage + '<br>' + debug.innerHTML;
        }
  

        const addiframes = (urls) => {
            

            if (window.innerWidth === 960 && window.innerHeight === 540) {
                //document.body.style.transform = 'scale(0.5)';
                //document.body.style.transformOrigin = '0 0';
            }

            const iframewrapper = document.getElementById('iframewrapper');

            urls.forEach((urlItem, index) => {
                
             // Set the URL of your content
                    scaler.setUrl(urlItem);
            
            });

           
        };

        



        function getScreenInfo() {
            log("Getting screen info...");
            const info = {
                // Screen dimensions
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                screenAvailWidth: window.screen.availWidth,
                screenAvailHeight: window.screen.availHeight,
                screenColorDepth: window.screen.colorDepth,
                screenPixelDepth: window.screen.pixelDepth,
                
                // Window dimensions
                windowInnerWidth: window.innerWidth,
                windowInnerHeight: window.innerHeight,
                windowOuterWidth: window.outerWidth,
                windowOuterHeight: window.outerHeight,
                
                // Device pixel ratio
                devicePixelRatio: window.devicePixelRatio,
                
                // Document dimensions
                documentWidth: document.documentElement.clientWidth,
                documentHeight: document.documentElement.clientHeight,
                
                // Media query information
                isFullHD: window.matchMedia('(min-width: 1920px)').matches,
                is4K: window.matchMedia('(min-width: 3840px)').matches,
                
                // Additional screen properties
                orientation: screen.orientation ? screen.orientation.type : 'unknown',
                refreshRate: screen.refreshRate || 'unknown'
            };

            log( JSON.stringify(info) );
        }
        

        function initializeReceiver() {
            
           

            try {
                log('Initializing receiver...');

                // Get the context
                const context = cast.framework.CastReceiverContext.getInstance();

                // Set maximum debug level
                context.setLoggerLevel(cast.framework.LoggerLevel.DEBUG);

                // Configure options
                const options = new cast.framework.CastReceiverOptions({
                    customNamespaces: {
                        'urn:x-cast:com.custom.message': cast.framework.system.MessageType.STRING
                    },
                    disableIdleTimeout: true,
                    skipPlaybackOnError: false
                });

                // Add system event listeners
                context.addEventListener(cast.framework.system.EventType.READY, () => {
                    log('READY - System is ready');
                    //getScreenInfo();
                });

                context.addEventListener(cast.framework.system.EventType.SENDER_CONNECTED, event => {
                    log('CONNECTED - Sender connected: ' + event.senderId);
                });

                context.addEventListener(cast.framework.system.EventType.SENDER_DISCONNECTED, event => {
                    log('DISCONNECTED - Sender disconnected: ' + event.senderId);
                });

                context.addEventListener(cast.framework.system.EventType.ERROR, event => {
                    log('ERROR - ' + JSON.stringify({
                        code: event.errorCode,
                        reason: event.reason,
                        customData: event.customData
                    }));
                });

                context.addEventListener(cast.framework.system.EventType.SHUTDOWN, () => {
                    log('SHUTDOWN - Receiver shutting down');
                });

            

                // Add message listener
                context.addCustomMessageListener(NAMESPACE, event => {
                    log('Message received: ' + JSON.stringify(event.data));
                    
                    const getScreenInfo = event.data.command;
                    const data =event.data.data;
                    
                    addiframes(data)

                    if (getScreenInfo === 'getScreenInfo') {
                       log('Sending screen info back to sender');
                        const info = data;
        
                        // Send screen info back to the specific sender
                        context.sendCustomMessage(NAMESPACE, event.senderId, {
                            'type': 'screenInfo',
                            'data': info
                        });

                      
                    }else{
                        log(getScreenInfo + ' is not a valid command')
                    }
                });
           
                // Start the receiver
                log('Starting receiver...');
                context.start(options);
                log('Receiver started and waiting for connection');

            } catch (error) {
                log('CRITICAL ERROR: ' + error.message);
                console.error('Full error:', error);
            }
        }

        // Initialize when the page loads
        window.addEventListener('load', () => {
            if (cast && cast.framework) {
                initializeReceiver();
            } else {
                log('ERROR: Cast API not available');
            }
        });
    </script>
        <script type="text/javascript" src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

</body>
</html>