<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Cast Setup</title>
    
    <!-- Cast SDK -->
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    
    <style>
        .status { padding: 10px; margin: 10px; border: 1px solid #ccc; }
        button { margin: 5px; padding: 8px; }
    </style>
</head>
<body>
    <h1>Basic Cast Setup</h1>
    <div>
        <button onclick="checkCastStatus()">Check Status</button>
        <button onclick="startCasting()">Start Cast</button>
        <button onclick="testDefaultReceiver()">Test Default Receiver</button>
    </div>
    <div id="status" class="status">Initializing...</div>

    <script>
        const CUSTOM_RECEIVER_APP_ID = 'ED052386';
        const DEFAULT_RECEIVER_APP_ID = 'CC1AD845';
        let currentAppId = CUSTOM_RECEIVER_APP_ID;
        
        // Initialize cast framework
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            }
        };

        function log(message) {
            const status = document.getElementById('status');
            const time = new Date().toLocaleTimeString();
            status.innerHTML += `<br>${time}: ${message}`;
            console.log(message);
        }

        function initializeCastApi() {
            try {
                cast.framework.CastContext.getInstance().setOptions({
                    receiverApplicationId: currentAppId,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
                
                // Add listeners
                const context = cast.framework.CastContext.getInstance();
                
                context.addEventListener(
                    cast.framework.CastContextEventType.CAST_STATE_CHANGED,
                    event => log(`Cast State: ${event.castState}`)
                );
                
                context.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    event => log(`Session State: ${event.sessionState}`)
                );
                
                log('Cast API initialized');
            } catch (error) {
                log(`Initialization Error: ${error.message}`);
            }
        }

        function checkCastStatus() {
            try {
                const context = cast.framework.CastContext.getInstance();
                const state = context.getCastState();
                const session = context.getCurrentSession();
                
                log(`Current Cast State: ${state}`);
                log(`Active Session: ${session ? 'Yes' : 'No'}`);
                
                if (session) {
                    log(`Session ID: ${session.getSessionId()}`);
                    log(`Session Status: ${session.getSessionState()}`);
                }
            } catch (error) {
                log(`Status Check Error: ${error.message}`);
            }
        }

        function startCasting() {
            try {
                const context = cast.framework.CastContext.getInstance();
                log('Requesting cast session...');
                
                context.requestSession()
                    .then(session => {
                        log('Session started successfully');
                        // Try to send a test message
                        return session.sendMessage('urn:x-cast:com.nokbok.helloworld', {
                            message: 'Hello from sender!',
                            timestamp: new Date().toISOString()
                        });
                    })
                    .then(() => log('Test message sent'))
                    .catch(error => {
                        log(`Cast Error: ${error.message || 'Unknown error'}`);
                        log(`Error Code: ${error.code || 'No code'}`);
                        if (error.description) log(`Description: ${error.description}`);
                    });
            } catch (error) {
                log(`Cast Error: ${error.message}`);
            }
        }

        function testDefaultReceiver() {
            try {
                // Switch to default receiver
                currentAppId = DEFAULT_RECEIVER_APP_ID;
                initializeCastApi();
                log('Switched to default receiver');
                setTimeout(startCasting, 1000); // Wait a second before casting
            } catch (error) {
                log(`Switch Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>