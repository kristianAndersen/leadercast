<!DOCTYPE html>
<html>
<head>
    <title>Simple Test Sender</title>
    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        body { font-family: Arial; margin: 20px; }
        button { padding: 10px; margin: 5px; }
        .log { 
            border: 1px solid #ccc; 
            padding: 10px; 
            margin-top: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Cast Test Sender</h1>
    <button onclick="initCast()">1. Initialize</button>
    <button onclick="startSession()">2. Start Session</button>
    <button onclick="sendMessage()">3. Send Message</button>
    <div id="log" class="log"></div>

    <script>
        let castContext = null;
        const APP_ID = '64F29018';

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `${time}: ${message}<br>` + logDiv.innerHTML;
            console.log(message);
        }

        window['__onGCastApiAvailable'] = function(isAvailable) {
            log(`Cast API available: ${isAvailable}`);
            if (isAvailable) initCast();
        };

        function initCast() {
            try {
                castContext = cast.framework.CastContext.getInstance();
                castContext.setOptions({
                    receiverApplicationId: APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });

                castContext.addEventListener(
                    cast.framework.CastContextEventType.CAST_STATE_CHANGED,
                    event => log(`Cast state: ${event.castState}`)
                );

                castContext.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    event => log(`Session state: ${event.sessionState}`)
                );

                log('Cast initialized');
            } catch (error) {
                log(`Init error: ${error.message}`);
            }
        }

        function startSession() {
            log('Starting session...');
            castContext.requestSession()
                .then(session => log('Session started'))
                .catch(error => log(`Session error: ${error.message || 'Unknown error'}`));
        }

        function sendMessage() {
            const session = castContext.getCurrentSession();
            if (!session) {
                log('No active session');
                return;
            }

            const message = {
                type: 'test',
                time: new Date().toISOString()
            };

            session.sendMessage('urn:x-cast:com.nokbok.helloworld', message)
                .then(() => log('Message sent'))
                .catch(error => log(`Message error: ${error.message}`));
        }
    </script>
</body>
</html>