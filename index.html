<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Receiver Test Sender</title>
    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script>
        let castSession = null;
        const CUSTOM_NAMESPACE = 'urn:x-cast:com.nokbok.helloworld';

        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            }
        };

        function initializeCastApi() {
            const context = cast.framework.CastContext.getInstance();
            context.setOptions({
                receiverApplicationId: 'ED052386',
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });

            // Listen for session state changes
            context.addEventListener(
                cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                event => {
                    console.log('Session State:', event.sessionState);
                    updateStatus('Session: ' + event.sessionState);
                }
            );
        }

        function sendMessage() {
            const session = cast.framework.CastContext.getInstance().getCurrentSession();
            if (session) {
                const message = {
                    type: 'test',
                    timestamp: new Date().toISOString()
                };
                
                session.sendMessage(CUSTOM_NAMESPACE, message)
                    .then(() => {
                        console.log('Message sent successfully');
                        updateStatus('Message sent');
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        updateStatus('Send error: ' + error);
                    });
            } else {
                updateStatus('No active session');
            }
        }

        function connect() {
            cast.framework.CastContext.getInstance()
                .requestSession()
                .then(session => {
                    console.log('Connected:', session);
                    updateStatus('Connected!');
                    castSession = session;
                })
                .catch(error => {
                    console.error('Error:', error);
                    updateStatus('Error: ' + error.message || error);
                });
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            console.log('Status:', message);
        }
    </script>
</head>
<body>
    <h1>Custom Receiver Test</h1>
    <button onclick="connect()">Connect</button>
    <button onclick="sendMessage()">Send Test Message</button>
    <div id="status">Not connected</div>
</body>
</html>