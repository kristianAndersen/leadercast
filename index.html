<!DOCTYPE html>
<html>
<head>
    <title>Dual Mode Cast Sender</title>
    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .button-group { margin: 10px 0; }
        button { 
            padding: 10px 20px; 
            margin: 5px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .log {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            background-color: #f8f9fa;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Dual Mode Cast Sender</h1>
    
    <div class="button-group">
        <h3>Default Receiver Mode</h3>
        <button onclick="initializeDefault()">1. Initialize Default Receiver</button>
        <button onclick="startDefaultSession()">2. Start Default Session</button>
        <button onclick="loadMedia()">3. Load Sample Media</button>
    </div>

    <div class="button-group">
        <h3>Custom Receiver Mode</h3>
        <button onclick="initializeCustom()">1. Initialize Custom Receiver</button>
        <button onclick="startCustomSession()">2. Start Custom Session</button>
        <button onclick="sendCustomMessage()">3. Send Test Message</button>
    </div>

    <div class="status" id="status">Not initialized</div>
    <div class="log" id="log"></div>

    <script>
        let castContext = null;
        const CUSTOM_APP_ID = 'ED052386';
        const DEFAULT_APP_ID = 'CC1AD845';
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `${time}: ${message}<br>` + logDiv.innerHTML;
            console.log(message);
            document.getElementById('status').textContent = message;
        }

        window['__onGCastApiAvailable'] = function(isAvailable) {
            log(`Cast API available: ${isAvailable}`);
        };

        function initializeCast(appId) {
            try {
                log(`Initializing Cast with App ID: ${appId}`);
                
                castContext = cast.framework.CastContext.getInstance();
                castContext.setOptions({
                    receiverApplicationId: appId,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });

                // Add listeners
                castContext.addEventListener(
                    cast.framework.CastContextEventType.CAST_STATE_CHANGED,
                    event => log(`Cast state: ${event.castState}`)
                );

                castContext.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    event => log(`Session state: ${event.sessionState}`)
                );

                log('Cast initialized successfully');
            } catch (error) {
                log(`Initialization error: ${error.message}`);
            }
        }

        function initializeDefault() {
            initializeCast(DEFAULT_APP_ID);
        }

        function initializeCustom() {
            initializeCast(CUSTOM_APP_ID);
        }

        async function startDefaultSession() {
            try {
                log('Starting default session...');
                const session = await castContext.requestSession();
                log('Default session started successfully');
            } catch (error) {
                log(`Session error: ${error.message || 'Unknown error'}`);
            }
        }

        async function startCustomSession() {
            try {
                log('Starting custom session...');
                const session = await castContext.requestSession();
                log('Custom session started successfully');
            } catch (error) {
                log(`Session error: ${error.message || 'Unknown error'}`);
            }
        }

        function loadMedia() {
            const session = castContext.getCurrentSession();
            if (!session) {
                log('No active session');
                return;
            }

            const mediaInfo = new chrome.cast.media.MediaInfo(
                'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                'video/mp4'
            );
            
            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            
            session.loadMedia(request)
                .then(() => log('Media loaded successfully'))
                .catch(error => log(`Media load error: ${error.message || 'Unknown error'}`));
        }

        function sendCustomMessage() {
            const session = castContext.getCurrentSession();
            if (!session) {
                log('No active session');
                return;
            }

            const message = {
                type: 'test',
                timestamp: new Date().toISOString()
            };

            session.sendMessage('urn:x-cast:com.nokbok.helloworld', message)
                .then(() => log('Custom message sent successfully'))
                .catch(error => log(`Message error: ${error.message || 'Unknown error'}`));
        }
    </script>
</body>
</html>