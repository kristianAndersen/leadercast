<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Custom Receiver Test</title>
    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
    <script>
        let applicationID = 'ED052386';
        let namespace = 'urn:x-cast:com.nokbok.helloworld';
        let session = null;

        // Initialize cast API when it's available
        window['__onGCastApiAvailable'] = function(loaded, errorInfo) {
            if (loaded) {
                initializeCastApi();
            } else {
                console.error('Cast API not available:', errorInfo);
                updateStatus('Cast API not available: ' + errorInfo);
            }
        };

        function initializeCastApi() {
            // Initialize API
            let sessionRequest = new chrome.cast.SessionRequest(applicationID);
            let apiConfig = new chrome.cast.ApiConfig(
                sessionRequest,
                sessionListener,
                receiverListener,
                chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            );

            chrome.cast.initialize(apiConfig, onInitSuccess, onInitError);
        }

        // Success callback for initialization
        function onInitSuccess() {
            console.log('Init success');
            updateStatus('Initialization successful');
        }

        // Error callback for initialization
        function onInitError(error) {
            console.error('Init error:', error);
            updateStatus('Initialization failed: ' + error.description);
        }

        // Callback on finding receivers
        function receiverListener(e) {
            console.log('Receiver status:', e);
            if (e === chrome.cast.ReceiverAvailability.AVAILABLE) {
                updateStatus('Chromecast available');
            } else {
                updateStatus('No Chromecast available');
            }
        }

        // Handle session
        function sessionListener(e) {
            console.log('New session:', e);
            session = e;
            updateStatus('Session connected');
        }

        // Launch the receiver app
        function launchApp() {
            console.log('Launching app...');
            updateStatus('Launching app...');
            
            chrome.cast.requestSession(
                function(e) {
                    session = e;
                    updateStatus('Session created');
                    console.log('Session created:', e);
                },
                function(error) {
                    console.error('Launch error:', error);
                    updateStatus('Launch failed: ' + error.description);
                }
            );
        }

        // Send a test message
        function sendMessage() {
            if (session) {
                let message = {
                    type: 'test',
                    message: 'Hello from sender!',
                    timestamp: new Date().toISOString()
                };

                session.sendMessage(namespace, message, 
                    function() {
                        console.log('Message sent');
                        updateStatus('Message sent successfully');
                    },
                    function(error) {
                        console.error('Message error:', error);
                        updateStatus('Failed to send message: ' + error);
                    }
                );
            } else {
                updateStatus('No active session');
            }
        }

        // Stop app
        function stopApp() {
            if (session) {
                session.stop(
                    function() {
                        console.log('Session stopped');
                        updateStatus('Session stopped');
                        session = null;
                    },
                    function(error) {
                        console.error('Stop error:', error);
                        updateStatus('Error stopping session: ' + error);
                    }
                );
            }
        }

        function updateStatus(message) {
            console.log(message);
            document.getElementById('status').textContent = message;
        }
    </script>
    <style>
        button {
            margin: 10px;
            padding: 10px;
        }
        #status {
            margin: 20px;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Basic Custom Receiver Test</h1>
    <button onclick="launchApp()">Launch App</button>
    <button onclick="sendMessage()">Send Test Message</button>
    <button onclick="stopApp()">Stop App</button>
    <div id="status">Initializing...</div>
</body>
</html>