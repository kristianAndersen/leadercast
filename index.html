<!DOCTYPE html>
<html>
<head>
    <title>Diagnostic Cast Sender</title>
    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        body { font-family: Arial; margin: 20px; }
        .button-container { margin-bottom: 20px; }
        button { 
            padding: 10px 20px; 
            margin: 5px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background: #ccc;
        }
        .log { 
            border: 1px solid #ccc; 
            padding: 10px; 
            margin-top: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            background: #f5f5f5;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            background: #e8f0fe;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Diagnostic Cast Sender</h1>
    
    <div class="status" id="castStatus">Cast Status: Unknown</div>
    
    <div class="button-container">
        <button onclick="initializeCastApi()">Initialize Cast API</button>
        <button onclick="checkCastState()">Check Cast State</button>
        <button id="connectButton" onclick="requestSession()" >Connect</button>
        <button id="testButton" onclick="testDefaultReceiver()" >Test Default Receiver</button>
    </div>

    <div class="log" id="log"></div>

    <script>
        let castContext = null;
        const CUSTOM_APP_ID = '64F29018';
        const DEFAULT_APP_ID = 'CC1AD845';
        let currentAppId = CUSTOM_APP_ID;

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `${time}: ${message}<br>` + logDiv.innerHTML;
            console.log(message);
        }

        function updateStatus(message) {
            document.getElementById('castStatus').textContent = 'Cast Status: ' + message;
        }

        // Initialize when Cast API is available
        window['__onGCastApiAvailable'] = function(isAvailable, error) {
            log(`Cast API available: ${isAvailable}${error ? ', Error: ' + error : ''}`);
            if (isAvailable) {
                initializeCastApi();
            }
        };

        function initializeCastApi() {
            try {
                log('Initializing Cast API...');
                
                // Initialize Cast API
                castContext = cast.framework.CastContext.getInstance();
                
                // Set options
                castContext.setOptions({
                    receiverApplicationId: currentAppId,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED,
                    language: 'en-US',
                    resumeSavedSession: false
                });

                // Add state change listener
                castContext.addEventListener(
                    cast.framework.CastContextEventType.CAST_STATE_CHANGED,
                    handleCastStateChange
                );

                // Add session state listener
                castContext.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    handleSessionStateChange
                );

                log('Cast API initialized successfully');
                checkCastState();

            } catch (error) {
                log(`Initialization error: ${error.message}`);
                console.error('Full error:', error);
            }
        }

        function handleCastStateChange(event) {
            const state = event.castState;
            log(`Cast state changed: ${state}`);
            updateStatus(state);
            updateButtons(state);
        }

        function handleSessionStateChange(event) {
            log(`Session state changed: ${event.sessionState}`);
        }

        function checkCastState() {
            if (!castContext) {
                log('Cast API not initialized');
                return;
            }

            const state = castContext.getCastState();
            log(`Current cast state: ${state}`);
            updateStatus(state);
            updateButtons(state);

            // Check if Chrome cast extension is available
            if (chrome.cast && chrome.cast.isAvailable) {
                log('Chrome cast extension is available');
            } else {
                log('Chrome cast extension is NOT available');
            }
        }

        function updateButtons(castState) {
            const connectButton = document.getElementById('connectButton');
            const testButton = document.getElementById('testButton');
            
            if (castState === cast.framework.CastState.NO_DEVICES_AVAILABLE) {
                connectButton.disabled = true;
                testButton.disabled = true;
                log('No cast devices available');
            } else if (castState === cast.framework.CastState.NOT_CONNECTED) {
                connectButton.disabled = false;
                testButton.disabled = false;
                log('Ready to connect to cast device');
            } else if (castState === cast.framework.CastState.CONNECTED) {
                connectButton.disabled = true;
                testButton.disabled = true;
                log('Connected to cast device');
            }
        }

        function requestSession() {
            if (!castContext) {
                log('Cast API not initialized');
                return;
            }

            log('Requesting cast session...');
            castContext.requestSession()
                .then(session => {
                    log('Session created successfully');
                    updateStatus('Connected');
                })
                .catch(error => {
                    log(`Session error: ${error.message || 'Unknown error'}`);
                    if (error.code) log(`Error code: ${error.code}`);
                    if (error.description) log(`Error description: ${error.description}`);
                    console.error('Full error:', error);
                });
        }

        function testDefaultReceiver() {
            try {
                log('Switching to default receiver...');
                currentAppId = DEFAULT_APP_ID;
                castContext.setOptions({
                    receiverApplicationId: currentAppId,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
                log('Switched to default receiver');
                setTimeout(requestSession, 1000);
            } catch (error) {
                log(`Error switching receiver: ${error.message}`);
                console.error('Full error:', error);
            }
        }
    </script>
</body>
</html>