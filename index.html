<!DOCTYPE html>
<html>
<head>
    <title>Cast Sender</title>
    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background: #ccc;
        }
        #status {
            padding: 15px;
            margin: 20px 0;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #debugOutput {
            font-family: monospace;
            padding: 15px;
            margin: 20px 0;
            background: #fff;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Cast Sender</h1>
    <div class="controls">
        <button onclick="checkCastState()">Check State</button>
        <button onclick="startCasting()">Start Casting</button>
        <button onclick="stopCasting()">Stop Casting</button>
        <button onclick="sendTestMessage()">Send Test Message</button>
    </div>
    <div id="status">Not initialized</div>
    <div id="debugOutput"></div>

    <script>
        const APP_ID = '64F29018';
        const NAMESPACE = 'urn:x-cast:com.leadercast.app';
        let castSession = null;
        
        function log(message) {
            const debugOutput = document.getElementById('debugOutput');
            const time = new Date().toLocaleTimeString();
            debugOutput.innerHTML = `${time}: ${message}<br>` + debugOutput.innerHTML;
            console.log(message);
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            log(message);
        }

        window['__onGCastApiAvailable'] = function(isAvailable) {
            log(`Cast API available: ${isAvailable}`);
            if (isAvailable) initializeCastApi();
        };

        function initializeCastApi() {
            try {
                log('Initializing Cast API...');
                cast.framework.CastContext.getInstance().setOptions({
                    receiverApplicationId: APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });

                // Add listeners
                cast.framework.CastContext.getInstance().addEventListener(
                    cast.framework.CastContextEventType.CAST_STATE_CHANGED,
                    event => log(`Cast state changed: ${event.castState}`)
                );

                cast.framework.CastContext.getInstance().addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    event => log(`Session state changed: ${event.sessionState}`)
                );

                log('Cast API initialized successfully');
            } catch (error) {
                log(`Initialization error: ${error.message}`);
            }
        }

        function checkCastState() {
            const context = cast.framework.CastContext.getInstance();
            const state = context.getCastState();
            const session = context.getCurrentSession();
            log(`Current cast state: ${state}`);
            log(`Active session: ${session ? 'Yes' : 'No'}`);
        }

        function startCasting() {
            log('Requesting cast session...');
            cast.framework.CastContext.getInstance().requestSession()
                .then(session => {
                    castSession = session;
                    log('Cast session established successfully');
                })
                .catch(error => {
                    log(`Failed to start casting: ${error.message || 'Unknown error'}`);
                    console.error('Cast error:', error);
                });
        }

        function stopCasting() {
            const session = cast.framework.CastContext.getInstance().getCurrentSession();
            if (session) {
                log('Stopping cast session...');
                session.endSession(true)
                    .then(() => log('Session ended'))
                    .catch(error => log(`Error ending session: ${error.message}`));
            } else {
                log('No active session to stop');
            }
        }

        function sendTestMessage() {
            const session = cast.framework.CastContext.getInstance().getCurrentSession();
            if (!session) {
                log('No active session');
                return;
            }

            const message = {
                type: 'test',
                timestamp: new Date().toISOString()
            };

            log('Sending test message...');
            session.sendMessage(NAMESPACE, message)
                .then(() => log('Message sent successfully'))
                .catch(error => log(`Failed to send message: ${error.message}`));
        }

        // Initialize when loaded
        if (cast && cast.framework) {
            initializeCastApi();
        }
    </script>
</body>
</html>