<!DOCTYPE html>
<html>
<head>
    <title>Test Cast Sender</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        button { 
            padding: 10px 20px; 
            margin: 5px;
            font-size: 16px;
        }
        #log {
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Test Cast Sender</h1>
    <div>
        <button onclick="initializeCast()">1. Initialize</button>
        <button onclick="checkAvailability()">2. Check Availability</button>
        <button onclick="startSession()">3. Start Session</button>
    </div>
    <div id="log"></div>

    <script>
        const APP_ID = '64F29018';
        let castContext = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `${time}: ${message}<br>` + logDiv.innerHTML;
            console.log(message);
        }

        window['__onGCastApiAvailable'] = function(isAvailable) {
            log(`Cast API available: ${isAvailable}`);
            if (isAvailable) initializeCast();
        };

        function initializeCast() {
            try {
                // Initialize using Chrome Cast V3 API
                const initializeConfig = new chrome.cast.ApiConfig(
                    new chrome.cast.SessionRequest(APP_ID),
                    sessionListener,
                    receiverListener,
                    chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                );

                chrome.cast.initialize(
                    initializeConfig,
                    () => log('Initialize success'),
                    error => log('Initialize error: ' + error.description)
                );

            } catch (error) {
                log('Error initializing: ' + error.message);
            }
        }

        function sessionListener(session) {
            log('New session: ' + session.sessionId);
        }

        function receiverListener(availability) {
            log('Receiver status: ' + availability);
        }

        function checkAvailability() {
            if (!chrome.cast || !chrome.cast.isAvailable) {
                log('Cast API not available');
                return;
            }

            try {
                const context = chrome.cast;
                log('Cast API status:');
                log('- API Available: ' + context.isAvailable);
                log('- Has Extension: ' + (!!window.chrome.cast));
            } catch (error) {
                log('Error checking availability: ' + error.message);
            }
        }

        function startSession() {
            log('Requesting session...');
            chrome.cast.requestSession(
                session => log('Session started: ' + session.sessionId),
                error => {
                    log('Session error: ' + error.description);
                    console.error('Detailed error:', error);
                }
            );
        }
    </script>
        <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

</body>
</html>