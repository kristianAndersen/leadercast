<!DOCTYPE html>
<html>
<head>
    <title>Cast Sender</title>
    <script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        body { font-family: Arial; margin: 20px; }
        button { 
            padding: 10px 20px; 
            margin: 5px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background: #ccc;
        }
        .log { 
            border: 1px solid #ccc; 
            padding: 10px; 
            margin-top: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>Cast Sender</h1>
    <div>
        <button id="initButton" onclick="initCast()">1. Initialize Cast</button>
        <button id="connectButton" onclick="connectDevice()">2. Connect to Device</button>
        <button id="messageButton" onclick="sendMessage()">3. Send Message</button>
    </div>
    <div id="log" class="log"></div>

    <script>
        let castContext = null;
        const APP_ID = 'ED052386';

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML = `${time}: ${message}<br>` + logDiv.innerHTML;
            console.log(message);
        }

        // Initialize when Cast API is available
        window['__onGCastApiAvailable'] = function(isAvailable) {
            log(`Cast API available: ${isAvailable}`);
            if (isAvailable) {
                initCast();
            }
        };

        function initCast() {
            try {
                log('Initializing Cast...');
                
                // Initialize Cast
                castContext = cast.framework.CastContext.getInstance();
                
                // Configure Cast options
                castContext.setOptions({
                    receiverApplicationId: APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });

                // Add listeners for cast state changes
                castContext.addEventListener(
                    cast.framework.CastContextEventType.CAST_STATE_CHANGED,
                    event => {
                        log(`Cast state changed: ${event.castState}`);
                        updateButtons(event.castState);
                    }
                );

                // Add listeners for session state changes
                castContext.addEventListener(
                    cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                    event => log(`Session state changed: ${event.sessionState}`)
                );

                log('Cast initialized successfully');
                updateButtons(castContext.getCastState());

            } catch (error) {
                log(`Initialization error: ${error.message}`);
            }
        }

        function connectDevice() {
            log('Requesting session...');
            
            castContext.requestSession()
                .then(session => {
                    log('Session created successfully');
                    updateButtons(castContext.getCastState());
                })
                .catch(error => {
                    log(`Session error: ${error.message || 'Unknown error'}`);
                    if (error.code) {
                        log(`Error code: ${error.code}`);
                    }
                });
        }

        function sendMessage() {
            const session = castContext.getCurrentSession();
            if (!session) {
                log('No active session');
                return;
            }

            const message = {
                type: 'test',
                timestamp: new Date().toISOString()
            };

            session.sendMessage('urn:x-cast:com.nokbok.helloworld', message)
                .then(() => log('Message sent successfully'))
                .catch(error => log(`Message error: ${error.message}`));
        }

        function updateButtons(castState) {
            const connectButton = document.getElementById('connectButton');
            const messageButton = document.getElementById('messageButton');
            
            if (castState === cast.framework.CastState.NO_DEVICES_AVAILABLE) {
                connectButton.disabled = true;
                messageButton.disabled = true;
            } else if (castState === cast.framework.CastState.NOT_CONNECTED) {
                connectButton.disabled = false;
                messageButton.disabled = true;
            } else if (castState === cast.framework.CastState.CONNECTED) {
                connectButton.disabled = true;
                messageButton.disabled = false;
            }
        }
    </script>
</body>
</html>